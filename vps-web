#!/bin/bash

# =================================================================
# 名称: VPS Web 全自动生产级调优与清理脚本 (3.0 终极版)
# 描述: 硬件感知调优 + BBR 强制激活 + 系统垃圾深度清理
# =================================================================

# 检查权限
[[ $EUID -ne 0 ]] && echo "Error: 请使用 root 权限运行" && exit 1

echo "--- 正在启动 [生产级] 硬件感知自适应调优系统 ---"

# 1. 硬件数据采集
TOTAL_MEM=$(free -m | awk '/^Mem:/{print $2}')
CPU_CORES=$(nproc)
KERNEL_MAJOR=$(uname -r | cut -d. -f1)
KERNEL_MINOR=$(uname -r | cut -d. -f2)

# 2. 核心逻辑：分级策略配置
SWAPPINESS=30
SOMAXCONN=1024
FILE_LIMIT=65535
BACKLOG=2048

if [ "$TOTAL_MEM" -lt 512 ]; then
    echo "状态: [微型机] 策略 - 优先保命 (避免OOM)"
    SWAPPINESS=80   
    SOMAXCONN=512
    BACKLOG=1024
elif [ "$TOTAL_MEM" -lt 1024 ]; then
    echo "状态: [轻量机] 策略 - 平衡型"
    SWAPPINESS=40
    SOMAXCONN=2048
    BACKLOG=4096
elif [ "$TOTAL_MEM" -lt 4096 ]; then
    echo "状态: [标准机] 策略 - 高性能"
    SWAPPINESS=20
    SOMAXCONN=8192
    BACKLOG=16384
else
    echo "状态: [大型生产级] 策略 - 极致吞吐"
    SWAPPINESS=10
    SOMAXCONN=65535
    BACKLOG=32768
    FILE_LIMIT=1048576
fi

# 3. 构造 sysctl 配置文件 (内核调优)
rm -f /etc/sysctl.d/99-web-optim.conf
cat > /etc/sysctl.d/99-web-optim.conf << EOL
# --- 网络基础加速 ---
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# --- 并发队列调优 ---
net.core.somaxconn = $SOMAXCONN
net.ipv4.tcp_max_syn_backlog = $(($SOMAXCONN * 2))
net.core.netdev_max_backlog = $BACKLOG
net.ipv4.tcp_slow_start_after_idle = 0

# --- 连接回收与安全 ---
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 20
net.ipv4.ip_local_port_range = 1024 65535

# --- 内存与文件系统 ---
vm.swappiness = $SWAPPINESS
fs.file-max = $(($FILE_LIMIT * 2))
vm.dirty_ratio = 20
vm.dirty_background_ratio = 10
EOL

# 4. 写入 Limits 限制 (文件句柄)
cat > /etc/security/limits.d/99-web-limits.conf << EOL
* soft nofile $FILE_LIMIT
* hard nofile $FILE_LIMIT
root soft nofile $FILE_LIMIT
root hard nofile $FILE_LIMIT
EOL

# 5. BBR 激活逻辑
modprobe tcp_bbr >/dev/null 2>&1
HAS_BBR=false
if [ "$KERNEL_MAJOR" -gt 4 ] || { [ "$KERNEL_MAJOR" -eq 4 ] && [ "$KERNEL_MINOR" -ge 9 ]; }; then
    if sysctl net.ipv4.tcp_available_congestion_control | grep -q bbr || [ -f /proc/sys/net/ipv4/tcp_congestion_control ]; then
        HAS_BBR=true
    fi
fi

if [ "$HAS_BBR" = true ]; then
    sysctl -p /etc/sysctl.d/99-web-optim.conf > /dev/null 2>&1
    sysctl -w net.core.default_qdisc=fq > /dev/null 2>&1
    sysctl -w net.ipv4.tcp_congestion_control=bbr > /dev/null 2>&1
    echo "成功: 内核调优与 BBR 激活完成。"
else
    echo "警告: 环境不支持 BBR，已降级处理。"
    sed -i '/bbr/d; /fq/d' /etc/sysctl.d/99-web-optim.conf
    sysctl -p /etc/sysctl.d/99-web-optim.conf > /dev/null 2>&1
fi

# 6. 深度清理垃圾文件 (Cleanup)
echo "--- 正在启动系统垃圾深度清理 ---"

# 清理日志文件 (保留最近 3 天)
if command -v journalctl >/dev/null 2>&1; then
    journalctl --vacuum-time=3d > /dev/null 2>&1
fi

# 清理旧的归档日志
find /var/log -type f -name "*.gz" -delete
find /var/log -type f -name "*.1" -delete

# 针对不同包管理器的清理
if command -v apt-get >/dev/null 2>&1; then
    # Debian/Ubuntu
    apt-get autoremove -y > /dev/null 2>&1
    apt-get autoclean -y > /dev/null 2>&1
    apt-get clean -y > /dev/null 2>&1
elif command -v yum >/dev/null 2>&1; then
    # CentOS/RHEL
    yum autoremove -y > /dev/null 2>&1
    yum clean all > /dev/null 2>&1
fi

# 清理临时文件
rm -rf /tmp/* > /dev/null 2>&1

echo "成功: 系统冗余文件清理完成。"

# 7. 结束输出
echo "------------------------------------------------"
echo "--- 调优与清理任务全部执行完毕！ ---"
echo "提示: 请退出并重新登录 SSH 以刷新 ulimit 限制。"
echo "建议: 别忘了检查你的 Nginx 配置以匹配新的文件句柄上限。"
